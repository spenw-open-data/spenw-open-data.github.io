<head>
	<!-- Load plotly.js into the DOM -->
	<script src='https://cdn.plot.ly/plotly-3.3.0.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<style>
		a.button, input.button {
                  background-color: #00a443;
                  color: white;
                  padding: 5px 20px;
                  text-align: center;
                  text-decoration: none;
                  display: inline-block;
                }
	</style>
	<title></title>
</head>

<body>
	<div style="max-height:500px">
		<div id='graph'><!-- Plotly chart will be drawn inside this DIV --><p>Data Loading...</p></div>
	</div>
	<div><a id='downloadLink' class='button'>Download Timeseries Data</a></div>
	<div style="max-height:500px">
		<div id='load-duration'><!-- Plotly chart will be drawn inside this DIV --><p>Data Loading...</p></div>
	</div>
	<div><a id='ld_downloadLink' class='button'>Download Load Duration Data</a></div>
	<script>
		//Obtain URL parameters
		let params = new URLSearchParams(document.location.search);
		let subnum = params.get("subnum"); 
		let feeder = params.get("feeder"); 
		
		document.title = 'Substation Loading (Substation: ' + subnum + ')';
		
		//Generate CSV file from data
		function downloadString(text, fileType, fileName) {
		  var blob = new Blob([text], { type: fileType });

		  var a = document.createElement('a');
		  a.download = fileName;
		  a.href = URL.createObjectURL(blob);
		  a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
		  a.style.display = "none";
		  document.body.appendChild(a);
		  a.click();
		  document.body.removeChild(a);
		  setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);
		}

		//Create CSV string from arrays
		function toCSV(col1, col2) {
			let lines = ["percentile,apparent_load_va"]; // header row (optional)

			for (let i = 0; i < col1.length; i++) {
				lines.push(`${col1[i]},${col2[i]}`);
			}

			return lines.join("\n");
		}


		function percentile(arr, p) {
			if (arr.length === 0) return null;

			const sorted = arr.slice().sort((a, b) => a - b);
			const index = (p / 100) * (sorted.length - 1);

			const lower = Math.floor(index);
			const upper = Math.ceil(index);

			if (lower === upper) return sorted[lower];

			// Linear interpolation
			const weight = index - lower;
			return sorted[lower] * (1 - weight) + sorted[upper] * weight;
		}



		//Load CSV data from zip file
		async function loadCsvFromZip(zipUrl, targetCsv) {
			// Fetch the ZIP file as an ArrayBuffer
			const response = await fetch(zipUrl);
			const arrayBuffer = await response.arrayBuffer();

			// Load ZIP using JSZip
			const zip = await JSZip.loadAsync(arrayBuffer);

			// Ensure the CSV exists
			if (!zip.files[targetCsv]) {
				console.error(`File ${targetCsv} not found inside ZIP`);
				document.getElementById('graph').innerHTML = `<p>Couldn't find substation data: ${targetCsv}</p>`
				return;
			}

			// Extract CSV text
			const csvText = await zip.files[targetCsv].async("text");

			return csvText;
		}

		//Main function to draw graph
		async function draw_graph() {
			//Load data
			let csv_data =  await loadCsvFromZip(
				"https://raw.githubusercontent.com/spenw-open-data/spenw-open-data.github.io/refs/heads/main/lv-visibility/data/" + feeder + ".zip",
				subnum + ".csv"
			);
			
			//Set download link
			document.getElementById('downloadLink').onclick = function() {downloadString(csv_data, 'text/csv', subnum + '-timeseries.csv');};

			//Parse CSV string
			const data = d3.csv.parseRows(csv_data, (d, i) => {
				return {
					time: new Date(d[0]),
					apparent_power: +d[1],
					real_power: +d[2],
					reactive_power: +d[3]
				};
			});
			
			//Utility unpack function
			function unpack(data, columnName) {
				return data.map(function(row) { return row[columnName]; });
			}
			
			//Generate Plotly data
			var apparent_power = {
			  type: "scatter",
			  mode: "lines",
			  name: 'Apparent Power (VA)',
			  x: unpack(data, 'time'),
			  y: unpack(data, 'apparent_power'),
			  line: {color: '#00A443'}
			}

			var real_power = {
			  type: "scatter",
			  mode: "lines",
			  name: 'Real Power (W)',
			  x: unpack(data, 'time'),
			  y: unpack(data, 'real_power'),
			  line: {color: '#FF9C1A'}
			}
			
			var reactive_power = {
			  type: "scatter",
			  mode: "lines",
			  name: 'Reactive Power (VAr)',
			  x: unpack(data, 'time'),
			  y: unpack(data, 'reactive_power'),
			  line: {color: '#0DA9FF'}
			}

			var graph_data = [apparent_power,real_power,reactive_power];


			var layout = {
			  height: 500,
			  title: {
				text: 'Substation Loading (Substation: ' + subnum + ')'
			  },
			  yaxis: {
				fixedrange: true,
				spikemode: 'across',
				},
			};

			//Draw graph
			Plotly.newPlot('graph', graph_data, layout, {scrollZoom: true});
			
			var percentiles = [10,25,50,75,90];
			var apparent_power_data = unpack(data, 'apparent_power');
			var load_duration_data = [percentile(apparent_power_data,10),percentile(apparent_power_data,25),percentile(apparent_power_data,50),percentile(apparent_power_data,75),percentile(apparent_power_data,90)];
			
			//Set download link
			document.getElementById('ld_downloadLink').onclick = function() {downloadString(toCSV(percentiles,load_duration_data), 'text/csv', subnum + '-loadduration.csv');};
			
			var load_duration = {
			  type: "scatter",
			  mode: "lines",
			  name: 'Load-Duration',
			  x: percentiles,
			  y: load_duration_data,
			  line: {color: '#0DA9FF'}
			}
			
			var ld_layout = {
			  height: 500,
			  title: {
				text: 'Substation Load-Duration Curve (Substation: ' + subnum + ')'
			  },
			  xaxis: {
				title: {text: 'Percentile'},
				automargin: true,
			  },
			  yaxis: { 
				title:  {text: 'Apparent Load (VA)'}, 
				automargin: true, 
			  },
			};

			//Draw graph
			Plotly.newPlot('load-duration', [load_duration], ld_layout, {scrollZoom: false});
			
		};
		
		if (subnum == null || feeder == null)
		{
			document.getElementById('graph').innerHTML = `<p>No feeder or substation specified. Please set the 'feeder' and 'subnum' parameters in the URL.</p>`;
		}
		else
		{
			document.getElementById('graph').innerHTML = ""
			document.getElementById('load-duration').innerHTML = ""
			//Trigger graph draw
			draw_graph();
		}



	</script>
</body>
